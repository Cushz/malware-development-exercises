#include <stdio.h>
#include <Windows.h>

// DOSHeader -> NTHeader -> OptionalHeader -> ImageExportDirectory

FARPROC CustomAddressFinder(HMODULE hModule, LPCSTR lpApiName)
{
    PBYTE pPE;
    pPE = (PBYTE)hModule;

    // Reading DOS Header by typcasting pointer to dos header
    PIMAGE_DOS_HEADER pImageDosHeader = (PIMAGE_DOS_HEADER)pPE;
    if (pImageDosHeader->e_magic != IMAGE_DOS_SIGNATURE)
    {
        printf("image DOS signature is invalid:%d\n", GetLastError());
        return 1;
    }
    // Reading NT header by using lfanew + pPE(base address)
    PIMAGE_NT_HEADERS pImageNTHeader = (PIMAGE_NT_HEADERS)(pPE + pImageDosHeader->e_lfanew);
    if (pImageNTHeader->Signature != IMAGE_NT_SIGNATURE)
    {
        printf("image NT signature is invalid:%d\n", GetLastError());
        return 1;
    }
    // Reading Optional Header
    printf("\n---------------OPTIONAL HEADER------------------\n");
    IMAGE_OPTIONAL_HEADER ImageOptionalHeader = pImageNTHeader->OptionalHeader;
    if (ImageOptionalHeader.Magic != IMAGE_NT_OPTIONAL_HDR_MAGIC)
    {
        printf("image optional signature is invalid:%d\n", GetLastError());
        return 1;
    }
    PIMAGE_EXPORT_DIRECTORY pImageExportDirectory = (PIMAGE_EXPORT_DIRECTORY)(pPE + ImageOptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);

    // Getting the Virtual addresses of the needed members of struct
    PDWORD ArrayOfFunctionNames = (PDWORD)(pPE + pImageExportDirectory->AddressOfNames);
    PDWORD ArrayOfFunctionAddress = (PDWORD)(pPE + pImageExportDirectory->AddressOfFunctions);
    PDWORD ArrayOfNameOrdinals = (PDWORD)(pPE + pImageExportDirectory->AddressOfNameOrdinals);

    //looping through exported functions
    for (DWORD i = 0; i < pImageExportDirectory->NumberOfFunctions; i++)
    {
        char* pFunctionName = (char*)(pPE + ArrayOfFunctionNames[i]);
        WORD  wFunctionOrdinal = ArrayOfNameOrdinals[i];

        PVOID pFunctionAddress = (PVOID)(pPE + ArrayOfFunctionAddress[wFunctionOrdinal]);
        printf("[%0.4d] NAME: %s -\t ADDRESS: 0x%p - \t ORDINAL: %d\n",i,pFunctionName,pFunctionAddress,wFunctionOrdinal);
    }
    
}

int main()
{
    CustomAddressFinder(GetModuleHandleA("ntdll.dll"),NULL);
    return 0;
}