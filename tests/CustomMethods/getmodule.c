#include <Windows.h>
#include <stdio.h>
#include <winternl.h>

HMODULE CustomModuleFinder(LPCWSTR szModuleName)
{
    // TEB -> PEB
    #ifdef _WIN64
        PTEB pTeb = (PTEB*)__readgsword(0x30); // or directly read 0x60 to get peb
        PPEB pPeb = (PPEB*)pTeb->ProcessEnvironmentBlock;
    #elif _WIN32
        PTEB pTeb = (PTEB*)__readgsword(0x18); // or directly read 0x30 to get peb
        PPEB pPeb = (PPEB*)pTeb->ProcessEnvironmentBlock;
    #endif

    // Getting LDR member from PEB
    PPEB_LDR_DATA pLdr = (PPEB_LDR_DATA)pPeb->Ldr;

    //Getting the first member from the linked list
    //documentation says that each node will be in this structure below
    PLDR_DATA_TABLE_ENTRY pDte = (PLDR_DATA_TABLE_ENTRY)(pLdr->InMemoryOrderModuleList.Flink);


    //Now we should iterate through it
    while (pDte)
    {
        if(pDte->FullDllName.Length != NULL)
        {
            wprintf(L"[i] \"%s\" \n",pDte->FullDllName.Buffer);
        }
        else
        {
            break;
        }
        pDte = *(PLDR_DATA_TABLE_ENTRY*)(pDte);
    }
    return NULL;

}

int main()
{

    CustomModuleFinder(L"ntdll.dll");
    return 0;
}