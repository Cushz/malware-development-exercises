#include <stdio.h>
#include <Windows.h>
#include <psapi.h>

#define MAX_PROCESSES 1024

int main(int argc, char *argv[])
{
    DWORD arrayOfPID[MAX_PROCESSES];
    DWORD actualSize;
    if(EnumProcesses(arrayOfPID,sizeof(arrayOfPID),&actualSize))
    {
        int count = actualSize / sizeof(DWORD);
        for (int i = 0; i < count; i++)
        {
            
            DWORD pid = arrayOfPID[i];
            HANDLE hProcess = OpenProcess(PROCESS_QUERY_LIMITED_INFORMATION,FALSE,pid);
            if (!hProcess)
            {
                printf("handle to the process error:%d\n",GetLastError());
                continue;
            }
            WCHAR processName[MAX_PATH];
            DWORD size = MAX_PATH;
            DWORD count = QueryFullProcessImageNameW(hProcess,0,processName,&size); //Other methods, such as EnumProcessModules,Getmodulebasename could be used as well
            wprintf(L"[%d]: %ls \n",arrayOfPID[i],processName);
            
        }
        
    }
    return 0;
}
