#include <stdio.h>
#include <Windows.h>
#include <winternl.h>

#define MAX_PROCESSES 1024

typedef NTSTATUS (NTAPI* fnNtQuerySystemInformation)
(
    SYSTEM_INFORMATION_CLASS SystemInformationClass,
    PVOID                    SystemInformation,
    ULONG                    SystemInformationLength,
    PULONG                   ReturnLength
);

fnNtQuerySystemInformation pNtQuerySystemInformation = NULL;

int main(int argc, char *argv[])
{
    NTSTATUS STATUS;
    ULONG   uReturnLen1,uReturnLen2;
    HANDLE hNative = GetModuleHandleW(L"NTDLL.DLL");
    PVOID pValueToFree = NULL;
    LPCWSTR ProcName = L"Notepad.exe";
    DWORD dwPid;
    HANDLE hProcess;
    PSYSTEM_PROCESS_INFORMATION ProcInfo = NULL;
    pNtQuerySystemInformation(5,NULL,0,&uReturnLen1); // this will help us to get the size
    pNtQuerySystemInformation = (fnNtQuerySystemInformation)GetProcAddress(hNative,"NtQuerySystemInformation");
    if(pNtQuerySystemInformation == NULL)
    {
        printf("error getting the address of the function:%d\n",GetLastError());
        return EXIT_FAILURE;
    }
    ProcInfo = (PSYSTEM_PROCESS_INFORMATION)HeapAlloc(GetProcessHeap(),HEAP_ZERO_MEMORY,(SIZE_T)uReturnLen1);//allocating memory according to the size
    
    pValueToFree = ProcInfo;

    STATUS = pNtQuerySystemInformation(5,ProcInfo,uReturnLen1,&uReturnLen2);
    if (STATUS != 0x0)
    {
        printf("Query failed:%d\n",GetLastError());
        return EXIT_FAILURE;
    }
    while (TRUE)
    {
        if(ProcInfo->ImageName.Length && wcscmp(ProcInfo->ImageName.Buffer,ProcName) == 0)
        {
            dwPid		= (DWORD)ProcInfo->UniqueProcessId;
            hProcess	= OpenProcess(PROCESS_ALL_ACCESS, FALSE, (DWORD)ProcInfo->UniqueProcessId);
			break;
        }
        if(!ProcInfo->NextEntryOffset)
        {
            break;
        }
        ProcInfo = (PSYSTEM_PROCESS_INFORMATION)((ULONG_PTR)ProcInfo + ProcInfo->NextEntryOffset);
    }
    HeapFree(GetProcessHeap(), 0, pValueToFree);
    printf("%d",dwPid);
    return 0;
}
//not fully understood yet