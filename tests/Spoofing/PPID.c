#include<stdio.h>
#include<Windows.h>

int main(int argc, char* argv[])
{
   PPROC_THREAD_ATTRIBUTE_LIST AttributeList;
   SIZE_T size;
   HANDLE hParent;
   DWORD targetParentPID = atoi(argv[1]);
   printf("target PID is this:%d\n",targetParentPID);
   hParent = OpenProcess(PROCESS_CREATE_PROCESS,FALSE,targetParentPID);
   if(hParent == NULL)
   {
    printf("failed to get parent process handle:%d\n",GetLastError());
    return FALSE;
   }
   InitializeProcThreadAttributeList(NULL,1,0,&size);
   AttributeList = (PPROC_THREAD_ATTRIBUTE_LIST)malloc(size); 
   if(InitializeProcThreadAttributeList(AttributeList,1,0,&size) == 0)
   {
        printf("failed to initialize attribute list:%d\n",GetLastError());
        return FALSE;
   }
   if(UpdateProcThreadAttribute(AttributeList,0,PROC_THREAD_ATTRIBUTE_PARENT_PROCESS,&hParent,sizeof(hParent),NULL,NULL) == 0)
   {
        printf("failed to update attribute:%d\n",GetLastError());
        return FALSE;
   }
   STARTUPINFOEX si = {sizeof(si)};
   si.lpAttributeList = AttributeList;

   PROCESS_INFORMATION pi ;
   char name[] = "C:\\Windows\\System32\\notepad.exe";
   if(!CreateProcess(NULL,name,NULL,NULL,FALSE,EXTENDED_STARTUPINFO_PRESENT,NULL,"C:\\Windows\\System32",&si.StartupInfo,&pi))
   {
        printf("failed to create process with another parent:%d\n",GetLastError());
        return FALSE;
   }
   DeleteProcThreadAttributeList(AttributeList);
   free(AttributeList);
   return 0;
}